pipeline {
    environment{
      dockerimagename = "nidhalmesselmani/my_docker_repo"
      dockerimage = ""
    }
    agent { 
        node {
            label 'docker-agent-cpp'
            }
      }
      stages {
        stage('Build Image') {
            steps {
                echo 'Building the image'
                script {
                  dir("my_cpp_app/source") {
                  sh "pwd"
                  sh "ls"
                  docker.build dockerimagename
                  }
                }
               /* sh '''
                cd my_cpp_app/source
                docker build -t nidhamesselmani/my_docker_repo:cpp_to_k8s .
                '''*/
            }
        }
        stage('Run the Image'){
          steps{
            echo 'RUNNING the container'
            sh '''
            docker run --name cpp_k8s --rm nidhamesselmani/my_docker_repo > runlog.txt
            cat runlog.txt
            '''
          }
        }
        stage('Push the Image to dockerhub'){
          steps{
            echo 'Push the image to dockerhub'
            script{
              docker.withRegistry('https://hub.docker.com/repository/docker/nidhamesselmani/my_docker_repo', 'dockerhublogin'){

              }

            }
            sh '''
              docker push nidhamesselmani/my_docker_repo:cpp_to_k8s
            '''
          }
        }
      }
       /*** workspace clean up*/
  post {
    always {
      cleanWs()
    }
  }  
}